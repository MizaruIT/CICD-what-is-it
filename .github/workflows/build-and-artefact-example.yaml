
# =========================
# WORKFLOW : définition du pipeline CI/CD (nom + déclencheurs + jobs)
# Fichier à placer dans : .github/workflows/ci.yml
# =========================
name: cicd-build-test-and-deploy-example

# -------------------------
# TRIGGERS : événements qui lancent le workflow
# - push : sur la branche main
# - pull_request : PR vers main
# - workflow_dispatch : exécution manuelle depuis l'UI
# -------------------------
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# -------------------------
# JOBS : blocs d'exécution indépendants
# Chaque job tourne sur un RUNNER (VM) et contient des STEPS (actions/commandes)
# Orchestration des jobs via 'needs' (dépendances)
# -------------------------
jobs:

  # ---- Job 1 : BUILD ----
  build:
    # RUNNER : machine fournie par GitHub (Linux)
    runs-on: ubuntu-latest
    steps: # STEPS : séquence d'actions et de commandes
      - name: Checkout
        uses: actions/checkout@v4        # Récupère le code du dépôt (révision de l'événement)

      - name: Build (exemple générique)
        run: |                           # Remplace ces commandes par ton build réel
          echo "Compiling..."
          mkdir -p out && echo "Hello CI" > out/app.txt

      # ARTEFACTS : fichiers produits par ce job, stockés pour les jobs suivants
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-out                  # Nom logique de l’artefact
          path: out/                     # Dossier/fichiers à partager (ex. /dist, binaire, etc.)

  # ---- Job 2 : TEST ----
  test:
    runs-on: ubuntu-latest
    needs: build                         # Dépend du job "build" (exécuter après)
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-out                  # Récupère l’artefact du job build

      - name: Run tests (exemple)
        run: |                           # Remplace par tes tests réels (unitaires/intégration)
          test -f app.txt
          grep -q "Hello CI" app.txt

  # ---- Job 3 : DEPLOY ----
  deploy:
    runs-on: ubuntu-latest
    needs: test                          # Dépend du job "test"
    if: github.ref == 'refs/heads/main'  # Garde-fou : déployer uniquement depuis main

    # ENVIRONNEMENT : contexte nommé (ex. staging/production) avec secrets/règles dédiés
    environment:
      name: staging                      # Configurable dans Settings > Environments du dépôt
      url: https://example.com/staging   # (Optionnel) URL affichée dans l’UI GitHub

    steps:
      - name: Deploy (simulation)
        run: echo "Deploying to staging..."  # Remplace par ta commande de déploiement (SSH, API, etc.)
